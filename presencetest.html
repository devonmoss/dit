<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Presence Test</title>
  <link rel="stylesheet" href="style.css" />
</head>
<body>
  <h1>Supabase Presence Test</h1>
  <p>Users connected to this page:</p>
  <ul id="presence-list"></ul>

  <!-- Supabase configuration (copy from index.html) -->
  <script>
    const SUPABASE_URL = 'https://kverifrebkciexkbkauq.supabase.co';
    const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Imt2ZXJpZnJlYmtjaWV4a2JrYXVxIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NDUwNzI2MDcsImV4cCI6MjA2MDY0ODYwN30.JHD_87VLGaURSuQeToyVhbDpss7FQZMMI3kB3rsUYmU';
  </script>
  <!-- Supabase JS client -->
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  <script>
    (async () => {
      // Initialize Supabase client
      const supabaseClient = supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

      // Determine presence key (persist per browser)
      let presenceId = localStorage.getItem('presencetest-id');
      if (!presenceId) {
        presenceId = Math.random().toString(36).substring(2, 10);
        localStorage.setItem('presencetest-id', presenceId);
      }
      // Determine username: use display name if available, otherwise remain as guest ID
      let username = presenceId;
      try {
        const {
          data: { session },
        } = await supabaseClient.auth.getSession();
        if (session && session.user) {
          const meta = session.user.user_metadata || {};
          if (meta.full_name) {
            username = meta.full_name;
          } else if (meta.name) {
            username = meta.name;
          }
          console.log(session.user);
          // if no display name;
        }
      } catch (e) {
        // ignore
      }

      // Create a presence channel
      const channel = supabaseClient.channel('presencetest', {
        config: { presence: { key: presenceId } }
      });

      // Subscribe to presence changes
      channel.on('presence', { event: 'sync' }, () => {
        const state = channel.presenceState();
        const listEl = document.getElementById('presence-list');
        listEl.innerHTML = '';
        Object.values(state).forEach((users) => {
          users.forEach((p) => {
            const li = document.createElement('li');
            li.textContent = p.user;
            listEl.appendChild(li);
          });
        });
      });

      // Start subscription and track presence
      await channel.subscribe();
      await channel.track({ user: username });
    })();
  </script>
</body>
</html>